<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menza</title>
    <base href="/" />
    <link href="styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@200..1000&display=swap">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0..1,0" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#869316">
    <meta name="theme-color" content="#f5f5dc">
</head>

<body>

<div style="position: fixed; width: 100vw; height: 100vh; display: flex; align-items: center"
     id="tempNextMenu">
    <div style="width: 100%">
        <div style="padding: 16px">
            <div class="surface">
                <span id="dateLabel"></span>
                <div>
                    <b><span id="nextMenu"></span></b>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="app">
    <div style="height: 4px; background: linear-gradient(69deg, rgba(14,0,255,1) 0%, rgba(255,0,0,1) 100%); width: var(--blazor-load-percentage); position: fixed; top: 0"></div>
</div>

<div id="blazor-error-ui">
    Valami nem jó.
</div>

<script src="_framework/blazor.webassembly.js"></script>
<script async type="module">
    import { signOut, signIn, onAccessTokenChanged } from "./auth.js";
    
    window.signOut = signOut;
    window.signIn = signIn;
    
    onAccessTokenChanged(accessToken => {
        DotNet.invokeMethod('Menza.Client', 'HandleCredential', accessToken);
    });

    async function loadNextMenu() {
        let response = await fetch('https://localhost:7181/next');
        let menu = await response.json();
        let nextDate = new Date(menu.date);
        let now = new Date();
        if (nextDate.getDate() === now.getDate() && nextDate.getMonth() === now.getMonth() && nextDate.getFullYear() === now.getFullYear())
            document.getElementById('dateLabel').outerText = 'Mai ebéd';
        else
            document.getElementById('dateLabel').outerText = `Következő ebéd - ${nextDate.toLocaleDateString('hu', {dateStyle: "full"})}`;

        document.getElementById('nextMenu').outerText = menu.value;
    }

    loadNextMenu();

    function scrollToNextMenu() {
        window.nextMenu.scrollIntoView({behavior: "smooth", block: "center"});
    }

    window.takeOver = async function(nextMenu) {
        window.nextMenu = nextMenu;
        
        const menus = document.getElementById('list').children;
        
        for (const menu of menus) {
            menu.classList.add('animated');
            if (menu.classList.contains('closed'))
                menu.classList.add('fade-in');
        }
        
        await new Promise(resolve => setTimeout(resolve));
        
        window.onscroll = _ => {
            const center = window.innerHeight / 2;
            for (const child of menus) {
                const rect = child.getBoundingClientRect();
                const isSelected = rect.top <= center && rect.bottom > center;
                const hidden = child.getElementsByClassName('hidden')[0];
                const content = hidden.children[0];
                hidden.style.height = isSelected ? content.clientHeight + 'px' : '0';
                child.classList.toggle('closed', !isSelected);
            }
        };        
        
        nextMenu.getElementsByClassName('date-and-menu')[0].scrollIntoView({behavior: "auto", block: "center"});
        document.getElementById('tempNextMenu').remove();
    }
</script>
</body>

</html>
